import { expect } from 'chai';
import fs from 'fs';
import chakram from 'chakram';
const assert = chakram.expect;
import _ from 'lodash';
import frisby from 'frisby';
import path from 'path';

describe('Events Penetration Tests', () => {

	const clientId = '28';
	const clientId_qa = '28';
	const clientName_qa = 'QA';
	const restrictedClientId = '30';
	const restrictedClientName = 'QA_API';
	const restrictedEventId = '9d3f7f64-f5d9-42b9-b66a-8cacd4030e18';
	const restrictedWaterfallId = 'b042f4ff-b124-400b-a089-bbccd5c73b8e';
	const eventId2 = '6492e572-afe0-4210-8f48-4fd7fd40e489';
	const waterfallName = 'Automation-DealByDeal';
	const waterfallId_totalreturn = '32043505-7f23-4a54-bfb0-a077bae4ff1a';
	const waterfallId_investran = 'd5b95dfb-780d-4479-aae9-a0bbe2ad330a'; // '27b12995-853f-4974-9aed-cd2aa96a9497'; <-- Use this for DEV2
	const waterfallName_investran = 'Automation-Investran';
	let eventId_investran = '';
	let random_waterfallname = 'AutoBot-' + Math.random().toString(36).substring(8);
	let cdEventName = 'API-Event-' + Math.random().toString(36).substring(8);
	let udEventName = Math.random().toString(36).substring(8);
	const currency = 'USD';
	let token = {};
	let newEventId = '';


	it("Add Event for Controller Role (Client - QA, User - cwf_dev_tier2)", (done) => {
		fs.readFile('tokens.json', 'utf8', function readFileCallback(err, data) {
			if (err) {
				console.log(err);
			} else {
				token = JSON.parse(data);
				let configBody = {
					headers: {
						'content-type': 'application/json',
						'Cookie': 'JWT=' + token.jwt + '; SMSESSION=' + token.smsession,
						'Connection': 'keep-alive'
					},
					body: {
						type: 'event',
						data: {
							attributes: {
								scenarioDistribution: false,
								eventName: cdEventName,
								eventType: 'Cash Distribution',
								eventDate: '02 Oct 2019',
								clientId: clientId_qa,
								clientName: clientName_qa,
								waterfallId: waterfallId_investran,
								waterfallName: waterfallName_investran,
								waterfallType: 'TOTAL_RETURN',
								calcMethod: 'IRR'
							}
						}
					},
					strictSSL: false
				}

				chakram.post(token.url + 'core/events', undefined, configBody)
					.then(function (res) {
						assert(res).to.have.status(201);
						let responseBody = JSON.parse(JSON.stringify(res.body));
						expect(responseBody['data']['type']).to.deep.equal('events');
						newEventId = responseBody['data']['attributes']['event']['eventId'];

						let eventResultConfig = {
							headers: {
								'content-type': 'application/json',
								'Cookie': 'JWT=' + token.jwt + '; SMSESSION=' + token.smsession,
								'waterfallId': waterfallId_investran
							},
							strictSSL: false
						}
						return chakram.get(token.url + `core/buckets/${waterfallId_investran}`, eventResultConfig)
					}).then(function (res) {
						assert(res).to.have.status(200);
						let checkDateConfig = {
							headers: {
								'content-type': 'application/json',
								'Cookie': 'JWT=' + token.jwt + '; SMSESSION=' + token.smsession
							},
							strictSSL: false,
							body: {
								type: 'eventResult',
								data: {
									attributes: {
										eventId: newEventId,
										scenarioDistribution: false,
										eventName: cdEventName,
										eventType: 'Cash Distribution',
										eventDate: '03 Oct 2019',
										clientId: '28',
										clientName: 'QA',
										waterfallId: waterfallId_investran,
										waterfallName: waterfallName_investran,
										waterfallType: 'TOTAL_RETURN',
										calcMethod: 'IRR',
										updatedBy: 'cwf_dev_tier2',
										updatedTime: '18 Oct 2019 17:54:02',
										status: 'No Results',
										lastSync: '17 Oct 2019 03:54:24 PM',
										checkDate: true
									}
								}
							}
						}

						return chakram.post(token.url + 'core/events/result/checkDate', undefined, checkDateConfig)
					}).then(function (res) {
						assert(res).to.have.status(222);
						let eventResultConfig = {
							headers: {
								'content-type': 'application/json',
								'Cookie': 'JWT=' + token.jwt + '; SMSESSION=' + token.smsession,
								'waterfallId': waterfallId_investran
							},
							strictSSL: false,
							body: {
								type: 'eventResult',
								data: {
									attributes: {
										eventId: newEventId,
										scenarioDistribution: false,
										eventName: cdEventName,
										eventType: 'Cash Distribution',
										eventDate: '02 Oct 2019',
										clientId: clientId_qa,
										clientName: clientName_qa,
										waterfallId: waterfallId_investran,
										waterfallName: waterfallName_investran,
										waterfallType: 'TOTAL_RETURN',
										calcMethod: 'IRR',
										updatedBy: 'CNanda',
										updatedTime: '18 Oct 2019 17:54:02',
										status: 'No Results',
										lastSync: '17 Oct 2019 03:54:24 PM',
										checkDate: false
									}
								}
							}
						}
						return chakram.post(token.url + 'core/events/result', undefined, eventResultConfig)
					}).then(function (res) {
						assert(res).to.have.status(201);
						let eventResultConfig = {
							headers: {
								'content-type': 'application/json',
								'Cookie': 'JWT=' + token.jwt + '; SMSESSION=' + token.smsession,
								'waterfallId': waterfallId_investran
							},
							strictSSL: false
						}

						return chakram.get(token.url + 'core/events/result/' + newEventId, eventResultConfig)
					}).then(function (res) {
						assert(res).to.have.status(200);

						// 	let downloadResultConfig = {
						// 		headers: {
						// 			'content-type': 'application/json',
						// 			'Cookie': 'JWT=' + token.jwt + '; SMSESSION=' + token.smsession,
						// 			'waterfallId': waterfallId_investran,
						// 			'clientName': clientName_qa
						// 		},
						// 		strictSSL: false
						// 	}

						// 	return chakram.get(token.url + `core/events/result/download?eventId=${newEventId}&eventResultNumber=1&clientName=${clientId_qa}`, downloadResultConfig)
						// }).then(function (res) {
						// 	assert(res).to.have.status(200);



						let deleteEventResultConfig = {
							headers: {
								'content-type': 'application/json',
								'Cookie': 'JWT=' + token.jwt + '; SMSESSION=' + token.smsession,
								'waterfallId': waterfallId_investran
							},
							strictSSL: false
						}
						return chakram.delete(token.url + 'core/events/result/' + newEventId + '/1?waterfallId=' + waterfallId_investran, undefined, deleteEventResultConfig)
					}).then(function (res) {
						assert(res).to.have.status(202);
						let deleteEventConfig = {
							headers: {
								'content-type': 'application/json',
								'Cookie': 'JWT=' + token.jwt + '; SMSESSION=' + token.smsession,
								'waterfallId': waterfallId_investran
							},
							strictSSL: false
						}
						return chakram.delete(token.url + 'core/events/' + waterfallId_investran + '/' + newEventId, undefined, deleteEventConfig)
					}).then(function (res) {
						assert(res).to.have.status(202);
					})
					.done(done);
			}
		});
	});
});

